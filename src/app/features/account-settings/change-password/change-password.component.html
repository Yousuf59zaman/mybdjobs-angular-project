<div class="gap-0.5 self-stretch bg-white rounded-xl border border-gray-200 border-solid shadow">
  <!-- Account Settings Header -->
  <header
    class="flex gap-5 items-center px-6 py-5 w-full border-b border-solid border-b-gray-200 max-md:px-5 max-md:max-w-full">
    <div class="flex flex-1 shrink gap-4 items-start self-stretch my-auto w-full basis-0 min-w-60 max-md:max-w-full">
      <div class="gap-1.5 min-w-60 max-md:max-w-full">
        <h1 class="text-2xl font-semibold leading-8 text-gray-900">
          Change Password
        </h1>
        <p class="mt-1.5 text-sm font-medium leading-5 text-gray-500 max-md:max-w-full">
          Keep your account secure by updating your password with a strong and unique one that's easy to remember.
        </p>
      </div>
    </div>
  </header>

  <div class="flex overflow-hidden flex-col gap-6 justify-center px-6 py-5 w-full max-md:px-5 max-md:max-w-full">
    <div class="flex flex-col gap-6 justify-center w-full max-md:max-w-full">
      <!-- Password Form (shown first) -->
      @if (!showOtpVerification()) {
      <div class="gap-8 self-center p-5 mt-6 max-w-full bg-white rounded-xl w-[724px]">
        <div class="gap-2 w-full max-md:max-w-full">
          <div class="flex flex-col gap-1 max-w-full w-[210px]">
            <!-- User Badge with Dynamic Data -->
            <div
              class="flex gap-1 items-center self-start py-0.5 pr-2 pl-1 bg-pink-50 rounded-full border border-pink-200 border-solid">
              @if (currentUser()) {
              <div class="flex overflow-hidden relative flex-col justify-center self-stretch my-auto w-4 aspect-square">
                <img [src]="currentUser()?.photoUrl" alt="User avatar"
                  class="object-cover absolute inset-0 size-full rounded-full" />
              </div>
              <span class="self-stretch my-auto text-xs font-medium leading-5 text-center text-pink-700">
                {{ currentUser()?.username }}
              </span>
              }
            </div>
            <div class="flex gap-2 items-center mt-1 w-full text-lg font-semibold leading-loose text-gray-900">
              <h3 class="self-stretch my-auto text-lg leading-7 text-gray-900">
                @if (hasAnyPassword()) {
                Change Password
                } @else {
                Create Password
                }
              </h3>
            </div>
          </div>
          <p class="mt-2 text-sm font-medium leading-5 text-gray-500 max-md:max-w-full">
            Choose a strong password and don't reuse it for other accounts.
          </p>
        </div>

        @if (hasAnyPassword()) {
        <form [formGroup]="passwordForm" (submit)="onSubmit($event)"
          class="flex flex-col gap-8 mt-8 w-full max-md:max-w-full">
          <!-- Current Password Field (only shown if user has existing password) -->
          <div class="gap-1.5 w-full min-h-20 max-md:max-w-full">
            <div class="flex flex-col flex-1 gap-1.5 w-full max-md:max-w-full">
              <div class="flex gap-0.5 items-start self-start text-sm font-medium leading-none text-slate-700">
                <label class="text-sm leading-5 text-slate-700">
                  Current Password
                </label>
              </div>
              <div class="relative">
                <app-input [type]="currentPasswordType()" [isDecimalAllowed]="false" [isNumericOnly]="false"
                  [isRequired]="true" [maxLength]="15" [control]="currentPasswordControl()"
                  [placeholder]="'Type current password'"></app-input>
                <span (click)="currentPasswordType.set(currentPasswordType() === 'password' ? 'text' : 'password')"
                  [ngClass]="currentPasswordType() === 'password' ? 'icon-eye-slash' : 'icon-eye'"
                  class="cursor-pointer text-[#5D6679] text-base absolute right-4 top-[18px]">
                </span>
              </div>
            </div>
          </div>

          <!-- New Password Field -->
          <div class="mt-5">
            <div class="gap-1.5 w-full min-h-20 max-md:max-w-full">
              <div class="flex flex-col flex-1 gap-1.5 w-full max-md:max-w-full">
                <div class="flex gap-0.5 items-start self-start text-sm font-medium leading-none text-slate-700">
                  <label class="text-sm leading-5 text-slate-700">
                    New Password
                  </label>
                  <div class="relative group w-fit">
                    <span class="icon-info text-[#48505E] cursor-pointer"></span>
                    <div
                      class="w-40 absolute bottom-full mb-3 left-1/2 -translate-x-1/2 px-2 py-1 font-medium text-[12px] text-white bg-[#595959] rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10"
                      role="tooltip">
                      Password must be 8 characters, including at least an uppercase, a lower case, a special character
                      & a number.
                    </div>
                  </div>
                </div>
                <div class="relative">
                  <app-input [type]="newPasswordType()" [isDecimalAllowed]="false" [isNumericOnly]="false"
                    [isRequired]="true" [maxLength]="15" [control]="newPasswordControl()"
                    [placeholder]="'Type new password'"></app-input>
                  <span (click)="newPasswordType.set(newPasswordType() === 'password' ? 'text' : 'password')"
                    [ngClass]="newPasswordType() === 'password' ? 'icon-eye-slash' : 'icon-eye'"
                    class="cursor-pointer text-[#5D6679] text-base absolute right-4 top-[18px]">
                  </span>
                </div>
              </div>
            </div>

            <!-- Password Strength Indicator -->
            @if (passwordValidation(newPasswordControl().value)) {
            @if (newPasswordControl().value) {
            <div class="flex items-center gap-1.5 mt-2">
              @for (color of getPasswordStrengthBars(newPasswordControl().value); track $index) {
              <div [ngClass]="color" class="w-[89px] h-1 rounded"></div>
              }
            </div>
            }
            @let validation = passwordValidation(newPasswordControl().value);
            <p class="text-xs font-medium" [ngClass]="{
                    'text-[#E42D27]': validation === 'weak' || validation === 'দুর্বল',
                    'text-[#FF9F40]': validation === 'average' || validation === 'মধ্যম',
                    'text-[#32A071]': validation === 'strong' || validation === 'শক্তিশালী'
                  }">
              {{ validation | titlecase }}
            </p>
            }
          </div>

          <!-- Confirm New Password Field -->
          <div class="mt-5">
            <div class="gap-1.5 w-full min-h-20 max-md:max-w-full">
              <div class="flex flex-col flex-1 gap-1.5 w-full max-md:max-w-full">
                <div class="flex gap-0.5 items-start self-start text-sm font-medium leading-none text-slate-700">
                  <label class="text-sm leading-5 text-slate-700">
                    Confirm New Password
                  </label>
                </div>
                <div class="relative">
                  <app-input [type]="confirmPasswordType()" [isDecimalAllowed]="false" [isNumericOnly]="false"
                    [isRequired]="true" [maxLength]="15" [control]="confirmPasswordControl()"
                    [placeholder]="'Type confirm password'"></app-input>
                  <span (click)="confirmPasswordType.set(confirmPasswordType() === 'password' ? 'text' : 'password')"
                    [ngClass]="confirmPasswordType() === 'password' ? 'icon-eye-slash' : 'icon-eye'"
                    class="cursor-pointer text-[#5D6679] text-base absolute right-4 top-[18px]">
                  </span>
                </div>
              </div>
            </div>
          </div>

          <button type="submit"
            class="flex overflow-hidden gap-1.5 justify-center items-center self-start px-4 py-2.5 text-base font-semibold text-white bg-pink-600 rounded-lg border-2 border-solid shadow-sm border-white border-opacity-10">
            <div class="flex justify-center items-center self-stretch px-0.5 py-0 my-auto">
              <span class="self-stretch my-auto text-base leading-6 text-white">
                Update Password
              </span>
            </div>
          </button>
        </form>
        } @else {
        <!-- Form for users with no existing password -->
        <form [formGroup]="noPasswordForm" (submit)="onSubmit($event)"
          class="flex flex-col gap-8 mt-8 w-full max-md:max-w-full">
          <!-- New Password Field -->
   <!-- New Password Field -->
<div class="mt-5">
  <div class="gap-1.5 w-full min-h-20 max-md:max-w-full">
    <div class="flex flex-col flex-1 gap-1.5 w-full max-md:max-w-full">
      <div class="flex gap-0.5 items-start self-start text-sm font-medium leading-none text-slate-700">
        <label class="text-sm leading-5 text-slate-700">
          New Password
        </label>
        <div class="relative group w-fit">
          <span class="icon-info text-[#48505E] cursor-pointer"></span>
          <div
            class="w-48 absolute bottom-full mb-3 left-1/2 -translate-x-1/2 px-2 py-1 font-medium text-[12px] text-white bg-[#595959] rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10"
            role="tooltip">
            Password must be:
            <ul class="list-disc pl-3 mt-1">
              <li>8-15 characters long</li>
              <li>Include uppercase letter</li>
              <li>Include lowercase letter</li>
              <li>Include a number</li>
              <li>Include special character</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="relative">
        <app-input [type]="newPasswordType()" [isDecimalAllowed]="false" [isNumericOnly]="false"
          [isRequired]="true" [maxLength]="15" [control]="newPasswordControl()"
          [placeholder]="'Type new password'"></app-input>
        <span (click)="newPasswordType.set(newPasswordType() === 'password' ? 'text' : 'password')"
          [ngClass]="newPasswordType() === 'password' ? 'icon-eye-slash' : 'icon-eye'"
          class="cursor-pointer text-[#5D6679] text-base absolute right-4 top-[18px]">
        </span>
      </div>
    </div>
  </div>

  <!-- Password Validation Messages -->
  @if (newPasswordControl().value) {
    <!-- Minimum Length Error -->
    @if (newPasswordControl().value.length < 8) {
      <p class="mt-1 text-xs font-medium text-red-500">
        Password must be at least 8 characters long
      </p>
    }
    
    <!-- Maximum Length Error -->
    @if (newPasswordControl().value.length > 15) {
      <p class="mt-1 text-xs font-medium text-red-500">
        Password cannot exceed 15 characters
      </p>
    }

    <!-- Invalid Characters Error -->
    @if (hasInvalidChars()) {
      <p class="mt-1 text-xs font-medium text-red-500">
        Password contains invalid characters (\\%&()<>\s)
      </p>
    }

    <!-- Strength Indicator (only shown when length is valid) -->
    @if (newPasswordControl().value.length >= 8 && newPasswordControl().value.length <= 15 && !hasInvalidChars()) {
      @if (passwordValidation(newPasswordControl().value)) {
        <div class="flex items-center gap-1.5 mt-2">
          @for (color of getPasswordStrengthBars(newPasswordControl().value); track $index) {
            <div [ngClass]="color" class="w-[89px] h-1 rounded"></div>
          }
        </div>
        @let validation = passwordValidation(newPasswordControl().value);
        <p class="text-xs font-medium" [ngClass]="{
          'text-[#E42D27]': validation === 'weak' || validation === 'দুর্বল',
          'text-[#FF9F40]': validation === 'average' || validation === 'মধ্যম',
          'text-[#32A071]': validation === 'strong' || validation === 'শক্তিশালী'
        }">
          {{ validation | titlecase }}
        </p>
      }
    }
  }
</div>



          <!-- Confirm New Password Field -->
          <div class="mt-5">
            <div class="gap-1.5 w-full min-h-20 max-md:max-w-full">
              <div class="flex flex-col flex-1 gap-1.5 w-full max-md:max-w-full">
                <div class="flex gap-0.5 items-start self-start text-sm font-medium leading-none text-slate-700">
                  <label class="text-sm leading-5 text-slate-700">
                    Confirm New Password
                  </label>
                </div>
                <div class="relative">
                  <app-input [type]="confirmPasswordType()" [isDecimalAllowed]="false" [isNumericOnly]="false"
                    [isRequired]="true" [maxLength]="15" [control]="confirmPasswordControl()"
                    [placeholder]="'Type confirm password'"></app-input>
                  <span (click)="confirmPasswordType.set(confirmPasswordType() === 'password' ? 'text' : 'password')"
                    [ngClass]="confirmPasswordType() === 'password' ? 'icon-eye-slash' : 'icon-eye'"
                    class="cursor-pointer text-[#5D6679] text-base absolute right-4 top-[18px]">
                  </span>
                </div>
              </div>
            </div>
          </div>

          <button type="submit"
            class="flex overflow-hidden gap-1.5 justify-center items-center self-start px-4 py-2.5 text-base font-semibold text-white bg-pink-600 rounded-lg border-2 border-solid shadow-sm border-white border-opacity-10">
            <div class="flex justify-center items-center self-stretch px-0.5 py-0 my-auto">
              <span class="self-stretch my-auto text-base leading-6 text-white">
                Continue to Verification
              </span>
            </div>
          </button>
        </form>
        }
      </div>
      }

      <!-- OTP Verification Form (shown after password form submission) -->
      @if (showOtpVerification()) {
      <form class="flex relative flex-col gap-8 items-start p-5 bg-white rounded-xl w-[724px]">
        <!-- Header with user badge -->
        <header class="flex relative flex-col gap-2 items-start self-stretch">
          <div class="flex relative flex-col gap-1 items-start">
            <!-- User Badge Component -->
            <div
              class="flex relative gap-1 items-center py-0.5 pr-2 pl-1 bg-pink-50 rounded-full border border-pink-200 border-solid">
              @if (currentUser()) {
              <div class="flex relative justify-center items-center w-4 h-4 rounded-full">
                <img [src]="currentUser()?.photoUrl" alt="Profile" class="w-full h-full rounded-full object-cover">
              </div>
              <span class="relative text-xs font-medium leading-5 text-center text-pink-700">
                {{ currentUser()?.username }}
              </span>
              }
            </div>

            <h1 class="relative text-lg font-semibold leading-7 text-gray-900">
              A verification code has been sent to {{ currentUser()?.email }}.
            </h1>
          </div>
        </header>

        <!-- Main content -->
        <main class="flex relative flex-col gap-10 items-start self-stretch">
          <section class="flex relative flex-col gap-2 items-start w-full">
            <!-- Code Input Group -->
            <div class="flex relative flex-col gap-1.5 items-start self-stretch">
              <label class="relative text-sm font-medium leading-5 text-slate-700">
                Secure code
              </label>
              <div
                class="flex relative gap-3 items-center max-md:flex-wrap max-md:gap-2 max-sm:flex-wrap max-sm:gap-1.5 max-sm:justify-center">
                <!-- First three input fields -->
                <!-- First three input fields -->
                <!-- First three input fields -->
                @for (value of firstThreeDigits; track $index) {
                <div
                  class="flex relative flex-col gap-2 justify-center items-center p-2 w-20 bg-white rounded-xl border shadow-sm min-h-20 max-md:text-4xl max-md:tracking-tighter max-md:leading-10 max-sm:text-3xl max-sm:tracking-tight max-sm:leading-9"
                  [class.border-red-500]="hasError()" [class.border-gray-300]="!hasError()">
                  <input type="text" maxlength="1" [value]="value"
                    (input)="updateCodeValue(getOtpInputIndex(true, $index), $event)"
                    class="relative self-stretch text-5xl font-medium tracking-tighter text-center leading-[60px] text-slate-700 bg-transparent border-none outline-none max-md:text-4xl max-md:tracking-tighter max-md:leading-10 max-sm:text-3xl max-sm:tracking-tight max-sm:leading-9" />
                </div>
                }

                <!-- Separator -->
                <div
                  class="relative text-6xl font-medium tracking-tighter text-center text-gray-300 leading-[72px] max-md:text-5xl max-md:tracking-tighter max-md:leading-[54px] max-sm:text-4xl max-sm:tracking-tighter max-sm:leading-10">
                  -
                </div>

                <!-- Next three input fields -->
                @for (value of lastThreeDigits; track $index) {
                <div
                  class="flex relative flex-col gap-2 justify-center items-center p-2 w-20 bg-white rounded-xl border shadow-sm min-h-20 max-md:text-4xl max-md:tracking-tighter max-md:leading-10 max-sm:text-3xl max-sm:tracking-tight max-sm:leading-9"
                  [class.border-red-500]="hasError()" [class.border-gray-300]="!hasError()">
                  <input type="text" maxlength="1" [value]="value"
                    (input)="updateCodeValue(getOtpInputIndex(false, $index), $event)"
                    class="relative self-stretch text-5xl font-medium tracking-tighter text-center leading-[60px] text-slate-700 bg-transparent border-none outline-none max-md:text-4xl max-md:tracking-tighter max-md:leading-10 max-sm:text-3xl max-sm:tracking-tight max-sm:leading-9" />
                </div>
                }
              </div>
            </div>

            <!-- Error Message and Timer -->
            <div class="flex justify-between items-center w-full">
              <!-- Error message (left side) -->
              @if (hasError()) {
              <div class="text-sm leading-5 text-red-500">
                {{ errorMessage() }}
              </div>
              } @else {
              <div class="text-sm leading-5 text-slate-500">
                Code valid for: {{ timeLeft() }}s
              </div>
              }

              <!-- Timer and resend (right side) -->
              <div class="text-sm leading-5 mr-28 text-slate-500">
                @if (hasError() && timeLeft() > 0) {
                <span>Code valid for: {{ timeLeft() }}s</span>
                }
                <span class="flex items-center">
                  <span class="text-slate-700">Didn't get a code?</span>
                  <button (click)="onResendCode()"
                    class="ml-2 font-semibold text-pink-600 underline bg-transparent border-none cursor-pointer">
                    Resend code
                  </button>
                </span>
              </div>
            </div>
          </section>

          <!-- Verify Button -->
          <button type="button" (click)="onVerify()"
            class="flex relative gap-1.5 justify-center items-center px-4 py-2.5 bg-pink-600 rounded-lg border-2 border-solid shadow-sm border-white border-opacity-10 max-sm:px-4 max-sm:py-3 max-sm:w-full disabled:opacity-50 disabled:cursor-not-allowed">
            <div class="flex relative justify-center items-center px-0.5 py-0">
              <span class="relative text-base font-semibold leading-6 text-white">
                {{ isLoading() ? 'Verifying...' : 'Verify & Update Password' }}
              </span>
            </div>
          </button>
        </main>
      </form>
      }
    </div>
  </div>
</div>